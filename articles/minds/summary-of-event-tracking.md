# 有关埋点统计的知识梳理

## 什么是埋点

埋点其实就是数据采集，为后续的 **分析**、**报警**、**优化** 等提供依据。

大多时候，我们要为数据进行语义化包装，才能让其他人更加轻松地为理解和使用它，不然繁杂的数据并无意义。<br />
可见，埋点其实是做三件事：1.**确定分析内容** 2.**制定数据语义** 3.**采集数据**。<br />

举个例子，我想统计每月新增用户，那么就需要规定什么是用户/什么是新用户，再由技术进行开发。

_这也是初体验埋点时会觉得没用的原因，因为它的语义可能并没有适配上你的理解；_<br />
_另外你也许会觉得应该是反着来的，先收集了数据再分析，那你可以看完全文后再思考下。_

## 确定分析内容

埋点的目的，也就是要分析的内容，会由不同的角色提出不同的需求，大致可以分为以下几种：<br />

- 运营埋点
- 安全性埋点
- 性能埋点
- 操作记录埋点
- 无语义埋点
- ...

### 运营埋点

营销的主要目的笼统来讲就两个：**企业的社会价值** 和 **产品的市场价值**；<br />
你可以将它们再抽象，其实可以去对应 **流量** 和 **销量**；<br />
再细化一些，常见的，流量有 PV、UV、触达率、留存率，销量有 投放量、付费率、续费率 等等。

产品想要的数据也可以划归在运营埋点里，操作记录只是一部分，还有停留时长、用户属性分布等。<br />
产品的主要目的不太一样，**寻找最优解**、**寻找潜在需求**、**优化现有流程**、**分析版本差异**

比如你想加大品牌宣传力度，但资金可能有限，<br />
-> 你需要埋点分析来源渠道的流量占比，然后再确定是加强群转发引导还是增加推文投放。

比如你发现某地区的流量相对流量较大，你猜是因为某事件，<br />
-> 你加急上线一个小活动蹭热度，用流量趋势来验证猜测，再确定要不要整波大的。

可见运营埋点是最不确定的，可能是曝光，可能是事件，会有各式各样有业务语义的指标，<br />
说一千道一万，运营和产品能主动使用数据分析来决定后续规划，是比较科学的进步。

### 安全性埋点

安全性埋点，也即埋点第二个目的：告警。常见的 **请求报错**、**请求异常**、**代码运行报错**、**应用崩溃** 等。<br />
在正式环境中，只要触发了这样的埋点上报，就应该有告警得找人来看了。

当然，埋点并不应只局限于运行时，也不是只有错误才上报，<br />
在 CI/CD、容器、网关/服务器 等阶段都可以加入安全性埋点。比如：

- build 所需时间通常都很长，所以成功或失败都告警，就不必盯着部署面板了
- 若 build 代码后代码体积增加超过 30kb 进行告警，避免引入不必要的包
- 若 1min 内启动容器 3 次进行告警，监控爆发式流量，或尽早发现服务异常

以上种种，安全性埋点能让开发立即反馈，或察觉异常降低负面影响。

### 性能埋点

前端比较熟悉的 TTFB、DCL、FP、FCP、FMP、LCP 都是可以进行性能分析的埋点；<br />
当然不仅是加载相关的，还有事件相关的 TTI、TBT、FID、SI 等。<br />
_这些已经比较规范化的指标可见文档 [https://web.dev/metrics/](https://web.dev/metrics/)_

除此之外，接口返回的时长和体积、资源加载的时长和体积、SDK 反馈的时长 等也是值得采集的性能数据。

以上埋点基本都可以做到无侵入式的埋点，使用系统 api 来实现 或 重写系统函数，小程序也是如此。<br />
比如 `window.PerformanceObserver`、`Page = MyPage` 等，或者像 `input[type="file"]` 使用组件或 api 方便统一埋点。

_至于内存性能与告警，我个人还没有遇到较好的观测方式，暂且不论_

### 操作记录埋点

以上三种埋点，都还未涉及具体的出入参。

若将 跳页、请求、事件、函数 相关的出入参都收集下来，<br />
那么开发就能比较准确地复现用户的操作，运营的漏斗也能做得更细分。

注入方式本人有些推荐，与性能埋点那种不侵入代码的有丢丢不同：

跳页我推荐封装函数，一方面是小程序类框架没有路由守卫，一方面是该封装可以拓展玩法（返回带参、不限参数格式等）

```js
$route('navigateTo', { url }, params);
$route('navigateBack', { delta: 1 }, params);
$getRouteParams();
```

请求也推荐封装公共方法，哪怕像 axios 有中间件也要，理由同上

```js
$request('/api', params, options);
```

事件在不同框架可能不一样，但都可以挂在元素的 `data-*` 上，然后全局事件冒泡 或 Vue 的自定义指令 或 小程序 methods 的劫持 等等

```vue
<template>
  <div
    @click="handleClick"
    :mark:tap="['event-id', 'event-desc']"
    :data-trick="{ data: {} }"
  />
</template>
```

函数多半是无需埋点的，流程较长 或 数据处理复杂 可比较自主地埋上一些，方便校验和排查。

```ts
logger.info('event-id', { data });
logger.warn('event-id', { data });
logger.error('event-id', { data });
```

**特别注意：** 操作记录埋点一定要绑定 session，才好去针对某个人进行分析，不然分分钟上万条记录是难以处理的。

### 无语义埋点

纯动作埋点，不在乎界面内是何元素，且不适用于复杂交互的页面。<br />
可以用于热点图，给 UI 设计师和交互设计师分析用的。类似于眼动仪。

<img src="https://s1.ax1x.com/2020/10/23/BA59UK.png" alt="点击热点图案例" width="320">

## 制定数据语义

制定数据语义，也可以说是约定协议，用什么格式的数据描述怎样的结果。

### 事件埋点

- 某人某时刻进行某交互
- 某时刻请求某接口得到某结果
- 某人在某处做某事所持续的时间段

### 数据的类型

- 来源渠道/流程（同步的(如从某人转发进入)，异步的(通过某人分享完成注册)）
- 设备信息（机型/手机尺寸/网络等）
- 用户信息（登录时间/性别/移动联通等）
- 地理位置

### 数据分析的类型

- 数量
- 比例
- 走势
- 对比

## 采集数据

上报时机（性能考量）：缓存上报，定时上报，即时上报<br />
上报数据类型（确定展示方式）：计数（该行为直接加一），自定义对象，持续时长<br />
上报数据分类（埋点数据会非常庞大，需分类/拆库等）：报错，系统，行为，流程<br />
